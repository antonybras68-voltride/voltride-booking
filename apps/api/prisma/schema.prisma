generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agency {
  id                String      @id @default(cuid())
  code              String      @unique
  name              Json
  address           String
  city              String
  postalCode        String
  country           String      @default("ES")
  phone             String
  email             String
  brand             String      @default("VOLTRIDE")
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  closingTimeSummer String      @default("19:00")
  closingTimeWinter String      @default("16:00")
  openingTime       String      @default("10:00")
  summerEndDate     String      @default("09-30")
  summerStartDate   String      @default("04-01")
  closedOnSunday    Boolean     @default(false)
  agencyType        AgencyType  @default(OWN)
  commissionRate    Float?
  commissionEmail   String?
  showStockUrgency  Boolean     @default(false)
  bookings          Booking[]
  inventory         Inventory[]
  fleetVehicles     Fleet[]
  contracts         RentalContract[]
  extensionSettings ExtensionSettings?
  schedulePeriods   AgencySchedulePeriod[]
  closures          AgencyClosure[]
}

model Category {
  id                String           @id @default(cuid())
  code              String           @unique
  name              Json
  brand             String           @default("VOLTRIDE")
  bookingFee        Float            @default(0)
  bookingFeePercentLow  Float  @default(50)
  bookingFeePercentHigh Float  @default(20)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  closingTimeSummer String           @default("19:00")
  closingTimeWinter String           @default("16:00")
  openingTime       String           @default("10:00")
  summerEndDate     String           @default("09-30")
  summerStartDate   String           @default("04-01")
  options           OptionCategory[]
  vehicles          Vehicle[]
  numberingCategoryId String?
  numberingCategory   VehicleNumberingCategory? @relation(fields: [numberingCategoryId], references: [id])
}

model Vehicle {
  id             String        @id @default(cuid())
  sku            String        @unique
  name           Json
  description    Json
  deposit        Float
  hasPlate       Boolean       @default(false)
  imageUrl       String?
  categoryId     String
  isActive       Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  helmetIncluded Boolean       @default(true)
  kmIncluded     Json?         @default("{}")
  licenseType    Json?         @default("{}")
  kmIncludedPerDay Int?          @default(100)
  extraKmPrice     Float?        @default(0.15)
  fuelChargeQuarter    Float    @default(5)
  fuelChargeHalf       Float    @default(10)
  fuelChargeThreeQ     Float    @default(15)
  fuelChargeEmpty      Float    @default(20)
  bookingItems   BookingItem[]
  inventory      Inventory[]
  pricing        Pricing[]
  category       Category      @relation(fields: [categoryId], references: [id])
  fleetVehicles         Fleet[]
  sparePartTemplates    VehicleSparePartTemplate[]
  rentalOptions         RentalOption[]
  characteristics       VehicleCharacteristic[]
}
model VehicleCharacteristic {
  id          String   @id @default(cuid())
  vehicleId   String
  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  label       Json
  shortLabel  String
  description Json
  icon        String?
  color       String   @default("#3b82f6")
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([vehicleId])
}

model Pricing {
  id         String   @id @default(cuid())
  vehicleId  String
  day1       Float    @default(0)
  day2       Float    @default(0)
  day3       Float    @default(0)
  day4       Float    @default(0)
  day5       Float    @default(0)
  day6       Float    @default(0)
  day7       Float    @default(0)
  day8       Float    @default(0)
  day9       Float    @default(0)
  day10      Float    @default(0)
  day11      Float    @default(0)
  day12      Float    @default(0)
  day13      Float    @default(0)
  day14         Float    @default(0)
  extraDayPrice Float    @default(0)
  extraHour1 Float    @default(0)
  extraHour2 Float    @default(0)
  extraHour3 Float    @default(0)
  extraHour4 Float    @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model Inventory {
  id        String   @id @default(cuid())
  vehicleId String
  agencyId  String
  quantity  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  agency    Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  @@unique([vehicleId, agencyId])
}

model Option {
  id                String           @id @default(cuid())
  code              String           @unique
  name              Json
  description       Json?
  maxQuantity       Int              @default(10)
  isActive          Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  day1              Float            @default(0)
  day2              Float            @default(0)
  day3              Float            @default(0)
  day4              Float            @default(0)
  day5              Float            @default(0)
  day6              Float            @default(0)
  day7              Float            @default(0)
  day8              Float            @default(0)
  day9              Float            @default(0)
  day10             Float            @default(0)
  day11             Float            @default(0)
  day12             Float            @default(0)
  day13             Float            @default(0)
  day14             Float            @default(0)
  includedByDefault Boolean          @default(false)
  sortOrder         Int              @default(0)
  imageUrl          String?
  bookingOptions    BookingOption[]
  categories        OptionCategory[]
}

model OptionCategory {
  id         String   @id @default(cuid())
  optionId   String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  option     Option   @relation(fields: [optionId], references: [id], onDelete: Cascade)
  @@unique([optionId, categoryId])
}

model Customer {
  id         String    @id @default(cuid())
  firstName  String
  lastName   String
  email      String
  phone      String
  address    String?
  postalCode String?
  city       String?
  country    String    @default("ES")
  language   String    @default("es")
  idDocumentUrl       String?   // URL photo pièce d'identité
  idDocumentExpiry    DateTime? // Date d'expiration
  licenseDocumentUrl  String?   // URL photo permis de conduire
  licenseDocumentExpiry DateTime? // Date d'expiration permis
  documentsVerified   Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  bookings   Booking[]
  contracts  RentalContract[]
}

model Booking {
  id            String          @id @default(cuid())
  reference     String          @unique
  agencyId      String
  customerId    String
  startDate     DateTime
  endDate       DateTime
  startTime     String
  endTime       String
  totalPrice    Float
  depositAmount Float
  status        String          @default("PENDING")
  language      String          @default("es")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  agency        Agency          @relation(fields: [agencyId], references: [id])
  customer      Customer        @relation(fields: [customerId], references: [id])
  items         BookingItem[]
  options       BookingOption[]
  fleetVehicleId        String?
  fleetVehicle          Fleet?          @relation(fields: [fleetVehicleId], references: [id])
  assignmentType        AssignmentType?
  assignedAt            DateTime?
  source                BookingSource   @default(WIDGET)
  autoAssign            Boolean         @default(true)
  contract              RentalContract?
  reallocations         ReservationReallocation[]
  isReallocated         Boolean         @default(false)
  reallocatedAt         DateTime?
  checkedIn             Boolean         @default(false)
  checkedInAt           DateTime?
  checkedOut            Boolean         @default(false)
  checkedOutAt          DateTime?
  paidAmount            Float           @default(0)
  paymentMethod         String?         // CARD, CASH, ONLINE
  conflictingExtensions ContractExtension[] @relation("ConflictingBooking")
  
  // Check-in fields
  startMileage            Int?
  fuelLevelStart          String?
  photoFront              String?
  photoLeft               String?
  photoRight              String?
  photoRear               String?
  photoCounter            String?
  idCardUrl               String?
  idCardVersoUrl          String?
  licenseUrl              String?
  licenseVersoUrl         String?
  signatureUrl            String?
  depositMethod           String?

  // Stripe deposit fields
  stripeCustomerId        String?
  stripePaymentMethodId   String?
  depositPaymentIntentId  String?
  depositStatus           String?   @default("PENDING") // PENDING, CARD_SAVED, AUTHORIZED, RELEASED, CAPTURED
  depositCapturedAmount   Float?
  depositCaptureReason    String?
}

model BookingItem {
  id         String   @id @default(cuid())
  bookingId  String
  vehicleId  String
  quantity   Int
  unitPrice  Float
  totalPrice Float
  createdAt  DateTime @default(now())
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])
}

model BookingOption {
  id         String   @id @default(cuid())
  bookingId  String
  optionId   String
  quantity   Int
  unitPrice  Float
  totalPrice Float
  createdAt  DateTime @default(now())
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  option     Option   @relation(fields: [optionId], references: [id])
}

model VehicleNumberingCategory {
  id              String    @id @default(cuid())
  code            String    @unique
  prefix          String
  name            String
  description     String?
  lastNumber      Int       @default(0)
  numberPadding   Int       @default(3)
  inspectionType  InspectionPhotoType @default(FULL)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  categories      Category[]
}

enum InspectionPhotoType {
  FULL
  SIMPLE
}

model Fleet {
  id                      String    @id @default(cuid())
  vehicleNumber           String    @unique
  licensePlate            String?
  chassisNumber           String    @unique
  vehicleId               String
  vehicle                 Vehicle   @relation(fields: [vehicleId], references: [id])
  agencyId                String
  agency                  Agency    @relation(fields: [agencyId], references: [id])
  locationCode            String?   // Code de localisation physique (V01, V02, M01, M02, etc.)
  year                    Int?
  color                   String?
  purchaseDate            DateTime?
  purchasePrice           Decimal?  @db.Decimal(10, 2)
  currentMileage          Int       @default(0)
  lastMileageUpdate       DateTime  @default(now())
  totalRentalDays         Int       @default(0)
  totalRentals            Int       @default(0)
  maintenanceIntervalType MaintenanceIntervalType @default(KILOMETERS)
  maintenanceIntervalKm   Int?      @default(1000)
  maintenanceIntervalDays Int?      @default(30)
  lastMaintenanceDate     DateTime?
  lastMaintenanceMileage  Int?
  nextMaintenanceDate     DateTime?
  nextMaintenanceMileage  Int?
  itvDate                 DateTime?
  itvExpiryDate           DateTime?
  insuranceCompany        String?
  insurancePolicyNumber   String?
  insuranceExpiryDate     DateTime?
  status                  FleetStatus @default(AVAILABLE)
  condition               VehicleCondition @default(GOOD)
  notes                   String?
  isActive                Boolean   @default(true)
  qrCodeUrl               String?
  maintenanceNotes        String?   @db.Text
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  documents               FleetDocument[]
  damages                 FleetDamage[]
  inspections             FleetInspection[]
  maintenanceRecords      MaintenanceRecord[]
  mileageLogs             MileageLog[]
  spareParts              FleetSparePart[]
  contracts               RentalContract[]
  bookings                Booking[]
  alternativeForExtensions ContractExtension[] @relation("AlternativeVehicle")
  originalInReallocations  ReservationReallocation[] @relation("OriginalVehicle")
  newInReallocations       ReservationReallocation[] @relation("NewVehicle")
  
  // Additional vehicle info
  brand                    String?
  model                    String?
  engineSize               String?   // Cylindrée
  
  // Relations to new models
  equipment                FleetEquipment[]
  stockMovements           StockMovement[]
  contractFields           FleetContractField[]
  
  @@index([vehicleId])
  @@index([agencyId])
  @@index([status])
  @@index([itvExpiryDate])
  @@index([insuranceExpiryDate])
}

enum FleetStatus {
  AVAILABLE
  RESERVED
  RENTED
  MAINTENANCE
  OUT_OF_SERVICE
  RETIRED
}

enum VehicleCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
}

enum MaintenanceIntervalType {
  KILOMETERS
  RENTAL_DAYS
  BOTH
}

enum AssignmentType {
  AUTOMATIC
  MANUAL
}

enum BookingSource {
  WIDGET
  WALK_IN
  MANUAL
  BACKOFFICE
}
enum AgencyType {
  OWN        // Tes propres agences
  PARTNER    // Hotels/Campings - commission a REVERSER
  FRANCHISE  // Franchises - commission a PRELEVER
}

enum CommissionType {
  REVERSAL    // A reverser au partenaire (PARTNER)
  DEDUCTION   // A prelever du franchise (FRANCHISE)
}

enum CommissionStatus {
  PENDING     // En attente
  CALCULATED  // Calculee
  PAID        // Payee/Prelevee
}

model FleetDocument {
  id              String       @id @default(cuid())
  fleetId         String
  fleet           Fleet        @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  type            DocumentType
  name            String
  fileUrl         String
  fileType        String
  fileSizeBytes   Int?
  thumbnailUrl    String?
  issueDate       DateTime?
  expiryDate      DateTime?
  sendToCustomer  Boolean      @default(false)
  description     String?
  uploadedBy      String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  @@index([fleetId])
  @@index([type])
  @@index([sendToCustomer])
}

enum DocumentType {
  CARTE_GRISE
  PERMIS_CIRCULATION
  FICHE_TECHNIQUE
  ASSURANCE
  RAPPORT_ITV
  CONSTAT_PREREMPLI
  TUTORIEL_VIDEO
  TUTORIEL_PHOTO
  MANUEL_UTILISATEUR
  OTHER
}

model FleetSparePart {
  id                String    @id @default(cuid())
  fleetId           String
  fleet             Fleet     @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  name              String
  partNumber        String?
  category          SparePartCategory
  location          DamageLocation
  price             Decimal   @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  totalCost         Decimal   @db.Decimal(10, 2)
  quantityInStock   Int       @default(0)
  minimumStock      Int       @default(1)
  supplierName      String?
  supplierRef       String?
  lastPurchasePrice Decimal?  @db.Decimal(10, 2)
  lastPurchaseDate  DateTime?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deductions        ContractDeduction[]
  @@index([fleetId])
  @@index([category])
}

model VehicleSparePartTemplate {
  id               String    @id @default(cuid())
  vehicleId        String
  vehicle          Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  name             String
  partNumber       String?
  category         SparePartCategory
  location         DamageLocation
  defaultPrice     Decimal   @db.Decimal(10, 2)
  defaultLaborCost Decimal?  @db.Decimal(10, 2)
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  @@index([vehicleId])
}

enum SparePartCategory {
  BODY
  MIRROR
  LIGHT
  WHEEL
  BRAKE
  HANDLEBAR
  SEAT
  BATTERY
  ACCESSORY
  OTHER
}

model FleetDamage {
  id              String           @id @default(cuid())
  fleetId         String
  fleet           Fleet            @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  description     String
  location        DamageLocation
  locationDetail  String?
  severity        DamageSeverity   @default(MINOR)
  photoUrl        String
  photoThumbnail  String?
  reportedAt      DateTime         @default(now())
  reportedBy      String?
  inspectionId    String?
  inspection      FleetInspection? @relation(fields: [inspectionId], references: [id])
  contractId      String?
  isResolved      Boolean          @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNote  String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  @@index([fleetId])
  @@index([isResolved])
}

enum DamageLocation {
  FRONT
  FRONT_LEFT
  FRONT_RIGHT
  LEFT
  RIGHT
  REAR
  REAR_LEFT
  REAR_RIGHT
  TOP
  BOTTOM
  HANDLEBAR
  SEAT
  WHEELS
  MIRROR_LEFT
  MIRROR_RIGHT
  LIGHTS_FRONT
  LIGHTS_REAR
  DASHBOARD
  OTHER
}

enum DamageSeverity {
  MINOR
  MODERATE
  MAJOR
  CRITICAL
}

model FleetInspection {
  id                 String           @id @default(cuid())
  fleetId            String
  fleet              Fleet            @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  contractId         String?
  contract           RentalContract?  @relation(fields: [contractId], references: [id])
  type               InspectionType
  mileage            Int
  condition          VehicleCondition
  fuelLevel          FuelLevel?
  photos             InspectionPhoto[]
  damages            FleetDamage[]
  customerSignature  String?
  customerSignedAt   DateTime?
  customerIpAddress  String?
  customerDeviceInfo String?
  operatorId         String
  operatorNotes      String?
  inspectedAt        DateTime         @default(now())
  isDeleted          Boolean          @default(false)
  deletedAt          DateTime?
  deletedBy          String?
  deleteReason       String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  @@index([fleetId])
  @@index([contractId])
  @@index([type])
  @@index([isDeleted])
}

enum InspectionType {
  CHECK_OUT
  CHECK_IN
  MAINTENANCE
  INVENTORY
}

enum FuelLevel {
  EMPTY
  QUARTER
  HALF
  THREE_QUARTERS
  FULL
}

model InspectionPhoto {
  id              String          @id @default(cuid())
  inspectionId    String
  inspection      FleetInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  angle           PhotoAngle
  photoUrl        String
  photoThumbnail  String?
  isValid         Boolean         @default(true)
  rejectionReason String?
  createdAt       DateTime        @default(now())
  @@unique([inspectionId, angle])
  @@index([inspectionId])
}

enum PhotoAngle {
  FRONT
  LEFT
  REAR
  RIGHT
  DASHBOARD
}

model MaintenanceRecord {
  id              String              @id @default(cuid())
  fleetId         String
  fleet           Fleet               @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  type            MaintenanceType
  description     String
  mileage         Int
  laborCost       Decimal?            @db.Decimal(10, 2)
  partsCost       Decimal?            @db.Decimal(10, 2)
  totalCost       Decimal?            @db.Decimal(10, 2)
  performedBy     String?
  invoiceNumber   String?
  invoiceUrl      String?
  scheduledDate   DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  status          MaintenanceStatus   @default(SCHEDULED)
  partsReplaced   Json?
  technicianId    String?
  technicianNotes String?
  priority        MaintenancePriority @default(NORMAL)
  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  @@index([fleetId])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
}

enum MaintenanceType {
  SCHEDULED
  REPAIR
  INSPECTION
  CLEANING
  TIRE_CHANGE
  BATTERY
  OIL_CHANGE
  BRAKE
  OTHER
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenancePriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model MileageLog {
  id              String        @id @default(cuid())
  fleetId         String
  fleet           Fleet         @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  previousMileage Int
  newMileage      Int
  difference      Int
  source          MileageSource
  referenceId     String?
  recordedBy      String?
  recordedAt      DateTime      @default(now())
  notes           String?
  @@index([fleetId])
  @@index([recordedAt])
}

enum MileageSource {
  CHECK_OUT
  CHECK_IN
  MAINTENANCE
  MANUAL
  INVENTORY
}

model RentalContract {
  id                   String            @id @default(cuid())
  contractNumber       String            @unique
  bookingId            String?           @unique
  booking              Booking?          @relation(fields: [bookingId], references: [id])
  fleetVehicleId       String
  fleetVehicle         Fleet             @relation(fields: [fleetVehicleId], references: [id])
  agencyId             String
  agency               Agency            @relation(fields: [agencyId], references: [id])
  customerId           String
  customer             Customer          @relation(fields: [customerId], references: [id])
  originalStartDate    DateTime
  originalEndDate      DateTime
  currentStartDate     DateTime
  currentEndDate       DateTime
  actualStartDate      DateTime?
  actualEndDate        DateTime?
  source               ContractSource
  dailyRate            Decimal           @db.Decimal(10, 2)
  totalDays            Int
  subtotal             Decimal           @db.Decimal(10, 2)
  optionsTotal         Decimal           @db.Decimal(10, 2) @default(0)
  discountAmount       Decimal           @db.Decimal(10, 2) @default(0)
  discountReason       String?
  taxRate              Decimal           @db.Decimal(5, 2) @default(21)
  taxAmount            Decimal           @db.Decimal(10, 2)
  totalAmount          Decimal           @db.Decimal(10, 2)
  depositAmount        Decimal           @db.Decimal(10, 2)
  depositMethod        PaymentMethod?
  depositReference     String?
  depositStatus        DepositStatus     @default(PENDING)
  depositCapturedAt    DateTime?
  depositReleasedAt    DateTime?
  totalDeductions      Decimal           @db.Decimal(10, 2) @default(0)
  deductionNotes       String?
  finalDepositRefund   Decimal?          @db.Decimal(10, 2)
  paymentStatus        PaymentStatus     @default(PENDING)
  paidAmount           Decimal           @db.Decimal(10, 2) @default(0)
  paymentMethod        PaymentMethod?
  paymentReference     String?
  customerSignature    String?
  customerSignedAt     DateTime?
  customerIpAddress    String?
  customerDeviceInfo   String?
  operatorSignature    String?
  operatorSignedAt     DateTime?
  operatorId           String?
  documentsSentAt      DateTime?
  documentsSentTo      String?
  startMileage         Int?
  endMileage           Int?
  startFuelLevel       String?
  endFuelLevel         String?
  fuelCharge           Decimal?          @db.Decimal(10, 2)
  photoFront           String?
  photoLeft            String?
  photoRight           String?
  photoRear            String?
  photoCounter         String?
  damageSchema         Json?
  equipmentChecklist   Json?
  customerIdCardUrl    String?
  customerIdCardVersoUrl String?
  customerLicenseUrl   String?
  termsAcceptedAt      DateTime?
  termsLanguage        String?
  totalMileage         Int?
  status               ContractStatus    @default(DRAFT)
  internalNotes        String?
  customerNotes        String?
  contractPdfUrl       String?
  extensionAccessToken String?           @unique @default(cuid())
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  inspections          FleetInspection[]
  deductions           ContractDeduction[]
  extensions           ContractExtension[]
  contractOptions      ContractOption[]
  payments             ContractPayment[]
  
  // Commissions partenaires/franchises
  commissionRate       Float?
  commissionAmount     Decimal?          @db.Decimal(10, 2)
  commissionType       CommissionType?
  commissionStatus     CommissionStatus  @default(PENDING)
  
  @@index([fleetVehicleId])
  @@index([customerId])
  @@index([agencyId])
  @@index([status])
  @@index([currentStartDate, currentEndDate])
}

enum ContractSource {
  ONLINE_WIDGET
  WALK_IN
  PHONE
  PARTNER
}

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE
  ACTIVE
  COMPLETED
  CANCELLED
  DISPUTED
}

enum DepositStatus {
  PENDING
  CAPTURED
  PARTIALLY_RELEASED
  RELEASED
  FORFEITED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

enum PaymentMethod {
  CARD
  CASH
  TRANSFER
  STRIPE
  OTHER
}

model ContractDeduction {
  id           String          @id @default(cuid())
  contractId   String
  contract     RentalContract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  type         DeductionType
  sparePartId  String?
  sparePart    FleetSparePart? @relation(fields: [sparePartId], references: [id])
  equipmentId  String?
  equipment    FleetEquipment? @relation(fields: [equipmentId], references: [id])
  description  String
  quantity     Int             @default(1)
  unitPrice    Decimal         @db.Decimal(10, 2)
  totalPrice   Decimal         @db.Decimal(10, 2)
  photoUrls    Json?
  validatedBy  String?
  validatedAt  DateTime?
  customerAgreed Boolean       @default(false)
  notes        String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  @@index([contractId])
  @@index([type])
}

enum DeductionType {
  DAMAGE
  MISSING_PART
  MISSING_ACCESSORY
  LATE_RETURN
  CLEANING
  FUEL
  OTHER
}

model ContractOption {
  id              String         @id @default(cuid())
  contractId      String
  contract        RentalContract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  rentalOptionId  String
  rentalOption    RentalOption   @relation(fields: [rentalOptionId], references: [id])
  name            String
  quantity        Int            @default(1)
  dailyPrice      Decimal        @db.Decimal(10, 2)
  totalPrice      Decimal        @db.Decimal(10, 2)
  returnedAt      DateTime?
  returnCondition String?
  createdAt       DateTime       @default(now())
  @@index([contractId])
}

model RentalOption {
  id              String           @id @default(cuid())
  name            String
  description     String?
  dailyPrice      Decimal          @db.Decimal(10, 2)
  depositPrice    Decimal          @db.Decimal(10, 2)
  vehicleId       String?
  vehicle         Vehicle?         @relation(fields: [vehicleId], references: [id])
  totalQuantity   Int              @default(0)
  availableQty    Int              @default(0)
  imageUrl        String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  contractOptions ContractOption[]
  @@index([vehicleId])
}

model ContractPayment {
  id              String                   @id @default(cuid())
  contractId      String
  contract        RentalContract           @relation(fields: [contractId], references: [id], onDelete: Cascade)
  type            PaymentType
  amount          Decimal                  @db.Decimal(10, 2)
  currency        String                   @default("EUR")
  method          PaymentMethod
  reference       String?
  stripePaymentId String?
  stripeStatus    String?
  status          PaymentTransactionStatus
  initiatedAt     DateTime                 @default(now())
  completedAt     DateTime?
  failedAt        DateTime?
  failureReason   String?
  refundedAmount  Decimal?                 @db.Decimal(10, 2)
  refundedAt      DateTime?
  refundReason    String?
  processedBy     String?
  notes           String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  @@index([contractId])
  @@index([type])
  @@index([status])
}

enum PaymentType {
  DEPOSIT
  RENTAL
  EXTENSION
  DEDUCTION
  REFUND
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model ContractExtension {
  id                      String                      @id @default(cuid())
  extensionNumber         String                      @unique
  contractId              String
  contract                RentalContract              @relation(fields: [contractId], references: [id], onDelete: Cascade)
  previousEndDate         DateTime
  requestedEndDate        DateTime
  approvedEndDate         DateTime?
  additionalDays          Int
  requestSource           ExtensionRequestSource
  requestedAt             DateTime                    @default(now())
  requestedBy             String?
  availabilityStatus      ExtensionAvailabilityStatus @default(PENDING_CHECK)
  availabilityCheckedAt   DateTime?
  currentVehicleAvailable Boolean                     @default(false)
  conflictingBookingId    String?
  conflictingBooking      Booking?                    @relation("ConflictingBooking", fields: [conflictingBookingId], references: [id])
  solutionType            ExtensionSolutionType?
  alternativeVehicleId    String?
  alternativeVehicle      Fleet?                      @relation("AlternativeVehicle", fields: [alternativeVehicleId], references: [id])
  reallocationId          String?                     @unique
  reallocation            ReservationReallocation?    @relation(fields: [reallocationId], references: [id])
  dailyRate               Decimal                     @db.Decimal(10, 2)
  subtotal                Decimal                     @db.Decimal(10, 2)
  taxRate                 Decimal                     @db.Decimal(5, 2) @default(21)
  taxAmount               Decimal                     @db.Decimal(10, 2)
  totalAmount             Decimal                     @db.Decimal(10, 2)
  stripePaymentLinkId     String?
  stripePaymentLinkUrl    String?
  stripePaymentLinkExpiresAt DateTime?
  stripeSessionId         String?
  stripePaymentIntentId   String?
  paymentStatus           PaymentStatus               @default(PENDING)
  paidAt                  DateTime?
  paidAmount              Decimal?                    @db.Decimal(10, 2)
  accessToken             String                      @unique @default(cuid())
  accessTokenExpiresAt    DateTime?
  customerSignature       String?
  customerSignedAt        DateTime?
  customerIpAddress       String?
  customerDeviceInfo      String?
  operatorId              String?
  operatorSignature       String?
  operatorSignedAt        DateTime?
  amendmentPdfUrl         String?
  status                  ExtensionStatus             @default(PENDING_AVAILABILITY_CHECK)
  rejectionReason         String?
  cancelledAt             DateTime?
  cancelledBy             String?
  cancellationReason      String?
  customerNotifiedAt      DateTime?
  operatorNotifiedAt      DateTime?
  notes                   String?
  internalNotes           String?
  createdAt               DateTime                    @default(now())
  updatedAt               DateTime                    @updatedAt
  @@index([contractId])
  @@index([status])
  @@index([accessToken])
}

enum ExtensionRequestSource {
  CUSTOMER_SELF_SERVICE
  OPERATOR_PHONE
  OPERATOR_IN_PERSON
  OPERATOR_PROACTIVE
}

enum ExtensionAvailabilityStatus {
  PENDING_CHECK
  AVAILABLE
  AVAILABLE_WITH_CHANGE
  AVAILABLE_WITH_REALLOC
  UNAVAILABLE
  REQUIRES_OPERATOR
}

enum ExtensionSolutionType {
  SAME_VEHICLE
  ALTERNATIVE_VEHICLE
  REALLOCATION
  PARTIAL_EXTENSION
  MANUAL_RESOLUTION
}

enum ExtensionStatus {
  PENDING_AVAILABILITY_CHECK
  CHECKING_AVAILABILITY
  AVAILABLE
  PENDING_OPERATOR_DECISION
  PENDING_PAYMENT
  PAYMENT_LINK_SENT
  PAYMENT_LINK_EXPIRED
  PENDING_SIGNATURE
  APPROVED
  REJECTED
  CANCELLED
  EXPIRED
  FAILED
}

model ReservationReallocation {
  id                 String             @id @default(cuid())
  bookingId          String
  booking            Booking            @relation(fields: [bookingId], references: [id])
  originalVehicleId  String
  originalVehicle    Fleet              @relation("OriginalVehicle", fields: [originalVehicleId], references: [id])
  newVehicleId       String
  newVehicle         Fleet              @relation("NewVehicle", fields: [newVehicleId], references: [id])
  reason             ReallocationReason
  extension          ContractExtension?
  performedBy        String
  performedAt        DateTime           @default(now())
  customerNotified   Boolean            @default(false)
  customerNotifiedAt DateTime?
  customerAccepted   Boolean?
  customerAcceptedAt DateTime?
  notes              String?
  isReverted         Boolean            @default(false)
  revertedAt         DateTime?
  revertedBy         String?
  revertReason       String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  @@index([bookingId])
  @@index([originalVehicleId])
  @@index([newVehicleId])
}

enum ReallocationReason {
  EXTENSION_REQUEST
  MAINTENANCE_REQUIRED
  VEHICLE_DAMAGE
  CUSTOMER_REQUEST
  OPERATIONAL
}

model StripePaymentLink {
  id                   String                   @id @default(cuid())
  referenceType        PaymentLinkReferenceType
  referenceId          String
  stripePaymentLinkId  String                   @unique
  stripePaymentLinkUrl String
  stripePriceId        String?
  stripeProductId      String?
  amount               Decimal                  @db.Decimal(10, 2)
  currency             String                   @default("EUR")
  createdAt            DateTime                 @default(now())
  expiresAt            DateTime
  isUsed               Boolean                  @default(false)
  usedAt               DateTime?
  stripeSessionId      String?
  createdBy            String?
  sentToEmail          String?
  sentAt               DateTime?
  sentBy               String?
  description          String?
  internalNotes        String?
  @@index([referenceType, referenceId])
  @@index([stripePaymentLinkId])
}

enum PaymentLinkReferenceType {
  CONTRACT_EXTENSION
  CONTRACT_DEPOSIT
  CONTRACT_RENTAL
  DAMAGE_PAYMENT
  OTHER
}

model ExtensionSettings {
  id                           String   @id @default(cuid())
  agencyId                     String?  @unique
  agency                       Agency?  @relation(fields: [agencyId], references: [id])
  selfServiceEnabled           Boolean  @default(true)
  maxSelfServiceDays           Int      @default(7)
  minHoursBeforeEnd            Int      @default(2)
  maxDaysBeforeEnd             Int      @default(3)
  autoReallocationEnabled      Boolean  @default(false)
  canReallocateOnlineBookings  Boolean  @default(false)
  canReallocatePhoneBookings   Boolean  @default(true)
  canReallocatePartnerBookings Boolean  @default(false)
  notifyReallocatedCustomer    Boolean  @default(true)
  requireReallocatedAcceptance Boolean  @default(false)
  paymentLinkExpirationHours   Int      @default(24)
  paymentReminderHours         Int      @default(6)
  useSameRate                  Boolean  @default(true)
  useCurrentRate               Boolean  @default(false)
  extensionSurchargePercent    Decimal? @db.Decimal(5, 2)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
}

model StripeWebhookEvent {
  id              String    @id @default(cuid())
  stripeEventId   String    @unique
  type            String
  payload         Json
  processedAt     DateTime?
  processingError String?
  referenceType   String?
  referenceId     String?
  receivedAt      DateTime  @default(now())
  @@index([stripeEventId])
  @@index([type])
  @@index([receivedAt])
}

model AvailabilityEvent {
  id             String                @id @default(cuid())
  eventType      AvailabilityEventType
  vehicleId      String
  agencyId       String
  fleetVehicleId String?
  startDate      DateTime
  endDate        DateTime
  referenceType  String
  referenceId    String
  quantityChange Int
  source         EventSource
  createdAt      DateTime              @default(now())
  @@index([vehicleId, agencyId])
  @@index([startDate, endDate])
  @@index([referenceType, referenceId])
}

enum AvailabilityEventType {
  RESERVED
  RELEASED
  BLOCKED
  UNBLOCKED
}

enum EventSource {
  WIDGET
  OPERATOR
  SYSTEM
  MAINTENANCE
}

model BrandSettings {
  id                     String   @id @default(cuid())
  brand                  String   @unique
  name                   String
  legalName              String?
  logoUrl                String?
  primaryColor           String?
  secondaryColor         String?
  email                  String?
  phone                  String?
  website                String?
  address                String?
  city                   String?
  postalCode             String?
  country                String   @default("ES")
  taxId                  String?
  stripePublishableKey   String?
  stripeSecretKey        String?
  stripeWebhookSecret    String?
  stripeAccountId        String?
  contractTemplateUrl    String?
  invoiceTemplateUrl     String?
  termsAndConditionsUrl  String?
  privacyPolicyUrl       String?
  emailFromName          String?
  emailFromAddress       String?
  
  // CGV et documents légaux (JSON avec fr/es/en)
  cgvResume              Json?    // { fr: "...", es: "...", en: "..." }
  cgvComplete            Json?    // { fr: "...", es: "...", en: "..." }
  rgpd                   Json?    // { fr: "...", es: "...", en: "..." }
  mentionsLegales        Json?    // { fr: "...", es: "...", en: "..." }
  
  isActive               Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// Tablet sessions for signature
model TabletSession {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  bookingId     String?
  agencyId      String
  type          String   @default("checkin") // checkin, checkout, contract
  status        String   @default("pending") // pending, active, signed, expired
  language      String   @default("fr")
  customerName  String?
  cgvText       String?  @db.Text
  rgpdText      String?  @db.Text
  signature     String?  @db.Text
  termsAccepted Boolean  @default(false)
  rgpdAccepted  Boolean  @default(false)
  signedAt      DateTime?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Walk-in customer data (temporary storage)
model WalkinSession {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  agencyId      String
  status        String   @default("pending") // pending, completed, expired
  language      String   @default("fr")
  
  // Customer data filled by client
  firstName     String?
  lastName      String?
  email         String?
  phone         String?
  phonePrefix   String?  @default("+34")
  address       String?
  city          String?
  postalCode    String?
  country       String?  @default("ES")
  
  // Brand info
  brand         String?  // VOLTRIDE or MOTOR-RENT
  
  completedAt   DateTime?
  expiresAt     DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Equipment provided with fleet vehicle
model FleetEquipment {
  id              String    @id @default(cuid())
  fleetId         String
  fleet           Fleet     @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  quantity        Int       @default(1)
  price           Decimal   @db.Decimal(10, 2)
  condition       String    @default("GOOD") // GOOD, FAIR, POOR
  isIncluded      Boolean   @default(true)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deductions      ContractDeduction[]
  @@index([fleetId])
}

// Contract display fields configuration per fleet
model FleetContractField {
  id              String    @id @default(cuid())
  fleetId         String
  fleet           Fleet     @relation(fields: [fleetId], references: [id], onDelete: Cascade)
  fieldName       String    // vehicleNumber, licensePlate, brand, model, etc.
  displayOrder    Int       @default(0)
  showInContract  Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@unique([fleetId, fieldName])
  @@index([fleetId])
}

model AppSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============== USERS & AUTHENTICATION ==============
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String   // Hashed password
  firstName     String
  lastName      String
  role          UserRole @default(OPERATOR)
  brands        String[] // ['VOLTRIDE', 'MOTOR-RENT']
  agencyIds     String[] // IDs des agences autorisées
  allowedApps   String[] // Apps autorisées dans le Launcher
  language      String   @default("es") // fr, es
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum UserRole {
  ADMIN        // Acces total
  MANAGER      // Gestion agences assignees
  OPERATOR     // Check-in/out, reservations
  ACCOUNTANT   // Lecture seule, factures
  COLLABORATOR // Partenaire externe (hotel/camping)
  FRANCHISEE   // Franchise - gere sa franchise
}

// ============== ROLE PERMISSIONS ==============
model RolePermission {
  id          String   @id @default(cuid())
  role        UserRole
  permission  String   // ex: 'dashboard', 'planning', 'fleet', etc.
  allowed     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([role, permission])
}

// ============== AGENCY SCHEDULE ==============
model AgencySchedulePeriod {
  id              String    @id @default(cuid())
  agencyId        String
  agency          Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  name            String    // Ex: "Été 2025", "Hiver 2025-2026"
  startDate       DateTime
  endDate         DateTime
  isDefault       Boolean   @default(false)
  
  // Lundi
  mondayOpen      String?   // "10:00"
  mondayClose     String?   // "19:00"
  mondayIsClosed  Boolean   @default(false)
  
  // Mardi
  tuesdayOpen     String?
  tuesdayClose    String?
  tuesdayIsClosed Boolean   @default(false)
  
  // Mercredi
  wednesdayOpen   String?
  wednesdayClose  String?
  wednesdayIsClosed Boolean @default(false)
  
  // Jeudi
  thursdayOpen    String?
  thursdayClose   String?
  thursdayIsClosed Boolean  @default(false)
  
  // Vendredi
  fridayOpen      String?
  fridayClose     String?
  fridayIsClosed  Boolean   @default(false)
  
  // Samedi
  saturdayOpen    String?
  saturdayClose   String?
  saturdayIsClosed Boolean  @default(false)
  
  // Dimanche
  sundayOpen      String?
  sundayClose     String?
  sundayIsClosed  Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([agencyId])
  @@index([startDate, endDate])
}

model AgencyClosure {
  id          String    @id @default(cuid())
  agencyId    String
  agency      Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String    // "Vacances", "Travaux", "Jour férié"
  createdAt   DateTime  @default(now())
  
  @@index([agencyId])
  @@index([startDate, endDate])
}


// ============== NOTIFICATION SETTINGS ==============
model NotificationSetting {
  id               String   @id @default(cuid())
  notificationType String   @unique
  roleAdmin        Boolean  @default(true)
  roleManager      Boolean  @default(true)
  roleOperator     Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// ============== PUSH NOTIFICATIONS ==============
model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  p256dh    String
  auth      String
  userId    String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

// ============== NOTIFICATIONS HISTORY ==============
model Notification {
  id          String   @id @default(cuid())
  userId      String?
  title       String
  body        String
  icon        String?
  data        Json?
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// ============== INTERNAL MESSAGING ==============
model Message {
  id          String   @id @default(cuid())
  fromUserId  String
  toUserId    String?  // null = message à tous
  toRole      String?  // ADMIN, MANAGER, OPERATOR = message à un rôle
  subject     String?
  body        String
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())
  
  @@index([fromUserId])
  @@index([toUserId])
  @@index([toRole])
  @@index([createdAt])
}
// Regenerate Prisma Tue Jan 20 21:00:35 UTC 2026

// ============== INVOICES ==============
model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  bookingId       String
  customerId      String
  agencyId        String
  brand           String   @default("VOLTRIDE")
  date            DateTime @default(now())
  dueDate         DateTime?
  subtotal        Float    @default(0)
  taxRate         Float    @default(21)
  taxAmount       Float    @default(0)
  totalTTC        Float    @default(0)
  paidAmount      Float    @default(0)
  remainingAmount Float    @default(0)
  deductions      Float    @default(0)
  depositRefunded Float    @default(0)
  status          String   @default("DRAFT")
  items           Json?
  options         Json?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([bookingId])
  @@index([customerId])
  @@index([agencyId])
  @@index([brand])
  @@index([status])
  @@index([date])
}

// ============== EXPENSES ==============
model Expense {
  id              String   @id @default(cuid())
  expenseNumber   String   @unique
  date            DateTime @default(now())
  supplier        String
  description     String
  category        String
  brand           String   @default("VOLTRIDE")
  subtotal        Float    @default(0)
  taxRate         Float    @default(21)
  taxAmount       Float    @default(0)
  totalTTC        Float    @default(0)
  paidAmount      Float    @default(0)
  status          String   @default("PENDING")
  documentUrl     String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([brand])
  @@index([category])
  @@index([date])
  @@index([status])
}

// ============== STOCK CENTRAL ==============
model InventoryPart {
  id                String    @id @default(cuid())
  name              String
  sku               String?   @unique
  barcode           String?   @unique
  category          StockCategory @default(GENERAL)
  vehicleType       String?   // CB, EB, EM, ALL
  imageUrl          String?
  price             Decimal   @db.Decimal(10, 2)
  laborCost         Decimal?  @db.Decimal(10, 2)
  quantityInStock   Int       @default(0)
  minimumStock      Int       @default(1)
  supplierName      String?
  supplierRef       String?
  supplierContact   String?
  location          String?   // Emplacement physique dans l'atelier
  compatibleFleetIds Json?     // Array of fleet vehicle IDs this part is compatible with
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  movements         StockMovement[]
  @@index([category])
  @@index([vehicleType])
  @@index([barcode])
}

model StockMovement {
  id              String    @id @default(cuid())
  partId          String
  part            InventoryPart @relation(fields: [partId], references: [id], onDelete: Cascade)
  type            MovementType
  quantity        Int
  fleetVehicleId  String?
  fleetVehicle    Fleet?    @relation(fields: [fleetVehicleId], references: [id])
  note            String?
  cost            Decimal?  @db.Decimal(10, 2)
  createdBy       String?
  createdAt       DateTime  @default(now())
  @@index([partId])
  @@index([fleetVehicleId])
  @@index([type])
}

enum StockCategory {
  BODY
  WHEEL
  BRAKE
  CHAIN
  LIGHT
  BATTERY
  SEAT
  HANDLEBAR
  ACCESSORY
  CONSUMABLE
  GENERAL
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  RETURN
}

// ============== DOCS TECHNIQUES ==============
model TechnicalDoc {
  id              String    @id @default(cuid())
  title           String
  vehicleCategory String    // CITY_BIKE, E_BIKE, E_MOTOCROSS
  docType         String    // MANUAL, EXPLODED_VIEW, WIRING, SPECS, OTHER
  fileUrl         String
  fileType        String?   // pdf, image, video
  description     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  @@index([vehicleCategory])
  @@index([docType])
}
